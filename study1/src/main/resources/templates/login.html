<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Đăng nhập - MMO Market</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <style>
        body {
            background: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }
        .login-page {
            min-height: 100vh;
            display: flex;
        }
        .left-section {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            position: relative;
        }
        .logo-container {
            margin-bottom: 2rem;
        }
        .logo {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            margin-bottom: 1rem;
        }
        .brand-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            border: 2px solid #e9ecef;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .brand-title {
            font-weight: 700;
            letter-spacing: 0.5px;
            font-size: 2.5rem;
            margin: 0;
            color: #667eea;
        }
        .brand-subtitle {
            font-size: 1.1rem;
            color: #6c757d;
            margin-top: 1rem;
        }
        .right-section {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background: white;
        }
        .login-form-container {
            max-width: 400px;
            width: 100%;
        }
        .login-card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            background: white;
            overflow: hidden;
            padding: 2rem;
        }
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        .input-group-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            border-radius: 10px 0 0 10px;
        }
        .form-control {
            border: 2px solid #e9ecef;
            border-radius: 0 10px 10px 0;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            transform: translateY(-2px);
        }
        .form-control.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 .25rem rgba(220,53,69,.25);
        }
        .invalid-feedback {
            display: block;
            font-size: 0.875rem;
            color: #dc3545;
            margin-top: 0.25rem;
        }
        .form-control.is-valid {
            border-color: #198754;
            box-shadow: 0 0 0 .25rem rgba(25,135,84,.25);
        }
        .form-check-input {
            width: 1.2em;
            height: 1.2em;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        .form-check-input:checked {
            background-color: #667eea;
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .form-check-input:focus {
            border-color: #86b7fe;
            outline: 0;
            box-shadow: 0 0 0 .25rem rgba(102, 126, 234, 0.25);
        }
        .form-check-label {
            color: #495057;
            font-size: 0.9rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        .btn-primary:disabled {
            opacity: 0.7;
            transform: none;
        }
        .link-primary {
            color: #667eea !important;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .link-primary:hover {
            color: #764ba2 !important;
            text-decoration: underline !important;
        }
        .alert {
            border: none;
            border-radius: 10px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
        }
        .alert-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
        }
        .alert-danger {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
        }
        .password-strength {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .strength-weak { color: #dc3545; }
        .strength-medium { color: #ffc107; }
        .strength-strong { color: #198754; }
        .remember-forgot-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .divider {
            text-align: center;
            margin: 1.5rem 0;
            position: relative;
        }
        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e9ecef;
        }
        .divider span {
            background: white;
            padding: 0 1rem;
            color: #6c757d;
            font-size: 0.9rem;
        }
        .google-btn {
            width: 100%;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        .google-btn:hover {
            border-color: #dc3545;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.2);
            color: #495057;
            text-decoration: none;
        }
        .footer-links {
            text-align: center;
            margin-top: 1.5rem;
        }
        .footer-links a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }
        .footer-links a:hover {
            color: #764ba2;
            text-decoration: underline;
        }
        @media (max-width: 768px) {
            .login-page {
                flex-direction: column;
            }
            .left-section {
                padding: 1rem;
                min-height: 40vh;
                background: #f8f9fa;
            }
            .brand-card {
                padding: 1.5rem;
                border: 1px solid #e9ecef;
            }
            .brand-title {
                font-size: 2rem;
            }
            .right-section {
                padding: 1rem;
            }
            .remember-forgot-container {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
        }
    </style>
    <meta name="base_url" th:content="@{/}">
    <script>
        // defer DOM-dependent actions until after DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function(){
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            if (error) {
                const alertEl = document.getElementById('alert');
                if (alertEl){
                    alertEl.textContent = 'Tên đăng nhập hoặc mật khẩu không đúng';
                    alertEl.classList.remove('d-none');
                }
            }

            // Load saved credentials if remember me was checked
            loadSavedCredentials();

            // Handle login form submission
            const loginForm = document.getElementById('loginForm');
            const loginBtn = document.getElementById('loginBtn');
            const rememberMeCheckbox = document.getElementById('rememberMe');
            
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                const rememberMe = rememberMeCheckbox.checked;
                
                // Basic frontend validation
                if (!username) {
                    alert('Vui lòng nhập tên đăng nhập');
                    return;
                }
                
                if (!password) {
                    alert('Vui lòng nhập mật khẩu');
                    return;
                }
                
                // Check username format (no special characters)
                const usernameRegex = /^[a-zA-Z0-9_]+$/;
                if (!usernameRegex.test(username)) {
                    alert('Tên đăng nhập không được chứa ký tự đặc biệt');
                    return;
                }
                
                // Check password length (minimum 6 characters)
                if (password.length < 6) {
                    alert('Mật khẩu phải có ít nhất 6 ký tự');
                    return;
                }
                
                // Save credentials if remember me is checked
                if (rememberMe) {
                    saveCredentials(username, password);
                } else {
                    clearSavedCredentials();
                }
                
                // Disable button and show loading
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Đang đăng nhập...';
                
                try {
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            username: username,
                            password: password
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // Store tokens
                        localStorage.setItem('accessToken', data.accessToken);
                        localStorage.setItem('refreshToken', data.refreshToken);
                        const cookieBase = `accessToken=${data.accessToken}; Path=/; Max-Age=3600; SameSite=Lax`;
                        document.cookie = (location.protocol === 'https:' ? `${cookieBase}; Secure` : cookieBase);
                        
                        // Show success message
                        alert('Đăng nhập thành công!');
                        
                        // Redirect to home immediately
                        window.location.href = '/';
                    } else {
                        alert('Tài khoản hoặc mật khẩu không đúng!');
                    }
                } catch (error) {
                    alert('Tài khoản hoặc mật khẩu không đúng!');
                } finally {
                    // Re-enable button
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = '<i class="fa-solid fa-right-to-bracket me-2"></i>Đăng nhập';
                }
            });
            
            function loadSavedCredentials() {
                const savedUsername = localStorage.getItem('savedUsername');
                const savedPassword = localStorage.getItem('savedPassword');
                const rememberMe = localStorage.getItem('rememberMe') === 'true';
                
                if (savedUsername && rememberMe) {
                    document.getElementById('username').value = savedUsername;
                    document.getElementById('password').value = savedPassword;
                    document.getElementById('rememberMe').checked = true;
                }
            }
            
            function saveCredentials(username, password) {
                localStorage.setItem('savedUsername', username);
                localStorage.setItem('savedPassword', password);
                localStorage.setItem('rememberMe', 'true');
            }
            
            function clearSavedCredentials() {
                localStorage.removeItem('savedUsername');
                localStorage.removeItem('savedPassword');
                localStorage.removeItem('rememberMe');
            }
            
            function showAlert(message, type) {
                // Remove existing alerts
                const existingAlerts = document.querySelectorAll('.alert');
                existingAlerts.forEach(alert => alert.remove());
                
                // Create new alert
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.role = 'alert';
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                // Insert at the top of the card
                const card = document.querySelector('.card');
                card.insertBefore(alertDiv, card.firstChild);
            }
        });
    </script>
</head>
<body>
    <div class="login-page">
        <!-- Left Section - Brand & Logo -->
        <div class="left-section">
            <div class="logo-container">
                <div class="logo">
                    <i class="fa-solid fa-cart-shopping"></i>
                </div>
            </div>
            <div class="brand-card">
                <h1 class="brand-title">MMO Market</h1>
                <p class="brand-subtitle">Chào mừng bạn quay trở lại!</p>
            </div>
        </div>
        
        <!-- Right Section - Login Form -->
        <div class="right-section">
            <div class="login-form-container">
                <div class="login-card">
                    <div th:if="${param.error}" class="alert alert-danger" role="alert">Tên đăng nhập hoặc mật khẩu không đúng</div>
                    <div th:if="${param.required}" class="alert alert-warning" role="alert">Vui lòng đăng nhập!</div>
                    <form id="loginForm">
            <div class="mb-3">
                <label for="username" class="form-label">Tên đăng nhập</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fa-solid fa-user"></i></span>
                    <input type="text" class="form-control" id="username" name="username" placeholder="username" required>
                </div>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Mật khẩu</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fa-solid fa-lock"></i></span>
                    <input type="password" class="form-control" id="password" name="password" placeholder="••••••••" required>
                </div>
            </div>
            <div class="mb-3 d-flex justify-content-between align-items-center">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="rememberMe" name="rememberMe">
                    <label class="form-check-label" for="rememberMe">
                        Lưu mật khẩu
                    </label>
                </div>
                <a class="link-primary text-decoration-none" th:href="@{/forgot-password}" href="/forgot-password">Quên mật khẩu?</a>
            </div>
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary" id="loginBtn">
                    <i class="fa-solid fa-right-to-bracket me-2"></i>Đăng nhập
                </button>
            </div>
        </form>
        
        <div class="divider">
            <span>hoặc</span>
        </div>
        
        <a href="/oauth2/authorization/google" class="google-btn">
            <i class="fab fa-google" style="color: #dc3545;"></i>
            Đăng nhập với Google
        </a>
        
        <div class="footer-links">
            <div>
                <span class="text-muted">Chưa có tài khoản?</span>
                <a th:href="@{/register}" href="/register" class="link-primary">Đăng ký</a>
            </div>
        </div>
    </div>
</div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js"></script>
</body>
</html>


