<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chi tiết người dùng - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <style>
        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: #333;
            z-index: 1000;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            border-right: 1px solid rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .sidebar.collapsed {
            transform: translateX(-100%);
        }
        
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .menu-section {
            padding: 1rem 0;
        }
        
        .section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #6c757d;
            padding: 0.5rem 1.5rem;
            margin-bottom: 0.5rem;
            letter-spacing: 0.5px;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: #495057;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        
        .menu-item:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border-left-color: #667eea;
        }
        
        .menu-item.active {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
            border-left-color: #667eea;
            font-weight: 600;
        }
        
        .menu-item i {
            width: 20px;
            margin-right: 0.75rem;
            text-align: center;
        }
        
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            background: #f8f9fa;
            transition: margin-left 0.3s ease;
        }
        
        .top-navbar {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .content-wrapper {
            padding: 2rem;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.show {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
        }
        
        .user-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 0.75rem;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .stats-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            border-radius: 0.75rem;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        }
        .stats-card.success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .stats-card.warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        .filter-card {
            border: 1px solid #e9ecef;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .table-card {
            border: 1px solid #e9ecef;
            border-radius: 0.75rem;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        }
        .pagination-custom .page-link {
            border-radius: 0.5rem;
            margin: 0 2px;
            border: 1px solid #dee2e6;
        }
        .pagination-custom .page-item.active .page-link {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .filter-badge {
            background-color: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        .order-status {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
        }
        .order-status.completed { background-color: #d4edda; color: #155724; }
        .order-status.pending { background-color: #fff3cd; color: #856404; }
        .order-status.cancelled { background-color: #f8d7da; color: #721c24; }
        
        /* Admin Layout Styles */
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }
        
        .top-navbar {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div th:replace="~{fragments/admin-sidebar :: admin-sidebar}"></div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Navbar -->
        <div class="top-navbar">
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-secondary me-3" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h4 class="mb-0">Chi tiết người dùng</h4>
            </div>
            
            <div class="d-flex align-items-center gap-3">
                <!-- Profile Dropdown -->
                <div class="dropdown">
                    <button class="btn btn-outline-primary dropdown-toggle d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown">
                        <img th:src="@{/api/profile/avatar/me}" 
                             class="rounded-circle" 
                             style="width: 24px; height: 24px; object-fit: cover;"
                             onerror="this.src='/images/default-avatar.svg';"
                             alt="Avatar">
                        <span th:text="${username}">Admin</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/profile">Thông tin cá nhân</a></li>
                        <li><a class="dropdown-item" href="/admin">Quản lý</a></li>
                        <li><a class="dropdown-item" href="/activity-history">Lịch sử hoạt động</a></li>
                        <li><a class="dropdown-item" href="/change-password">Đổi mật khẩu</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/logout">Đăng xuất</a></li>
                    </ul>
                </div>
            </div>
        </div>

<main class="container py-4 py-md-5">
    <!-- User Header -->
    <div class="user-header">
        <div class="row align-items-center">
            <div class="col-md-2 text-center">
                <img th:src="@{/api/profile/avatar/me}" 
                     class="rounded-circle border border-3 border-white" 
                     style="width: 80px; height: 80px; object-fit: cover;"
                     alt="Avatar"
                     onerror="this.src='/images/default-avatar.svg'">
            </div>
            <div class="col-md-8">
                <h2 class="mb-1" th:text="${user?.fullName ?: user?.username}">User Name</h2>
                <p class="mb-1" th:text="${user?.email}">user@example.com</p>
                <p class="mb-0">
                    <span class="badge bg-light text-dark me-2" th:text="${user?.role}">USER</span>
                    <span class="badge bg-success" th:text="${user?.status}">ACTIVE</span>
                </p>
            </div>
            <div class="col-md-2 text-end">
                <div class="d-flex gap-2">
                    <button class="btn btn-warning" th:onclick="'changeUserRole(' + ${user.id} + ')'" th:if="${user.role.name() != 'ADMIN'}">
                        <i class="fa-solid fa-user-gear me-2"></i>Đổi role
                    </button>
                    <a th:href="@{/admin/users}" class="btn btn-light">
                        <i class="fa-solid fa-arrow-left me-2"></i>Quay lại
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <i class="fa-solid fa-shopping-cart fa-2x mb-2"></i>
                    <h4 th:text="${totalOrders}">0</h4>
                    <p class="mb-0">Tổng đơn hàng</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card success">
                <div class="card-body text-center">
                    <i class="fa-solid fa-money-bill-wave fa-2x mb-2"></i>
                    <h4 th:text="${#numbers.formatDecimal(totalSpent, 0, 'COMMA', 0, 'POINT')}">0</h4>
                    <p class="mb-0">Tổng chi tiêu (VNĐ)</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card warning">
                <div class="card-body text-center">
                    <i class="fa-solid fa-wallet fa-2x mb-2"></i>
                    <h4 th:text="${#numbers.formatDecimal(walletBalance, 0, 'COMMA', 0, 'POINT')}">0</h4>
                    <p class="mb-0">Số dư hiện tại</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <i class="fa-solid fa-calendar-plus fa-2x mb-2"></i>
                    <h4 th:text="${#temporals.format(userCreatedAt, 'dd/MM/yyyy')}">01/01/2025</h4>
                    <p class="mb-0">Ngày tham gia</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card filter-card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fa-solid fa-filter me-2"></i>Bộ lọc
            </h5>
        </div>
        <div class="card-body">
            <form id="filterForm" method="get">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="orderStatus" class="form-label">Trạng thái đơn hàng</label>
                        <select class="form-select" id="orderStatus" name="status">
                            <option value="">Tất cả</option>
                            <option value="PENDING">Đang chờ</option>
                            <option value="COMPLETED">Hoàn thành</option>
                            <option value="CANCELLED">Đã hủy</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="dateFrom" class="form-label">Từ ngày</label>
                        <input type="date" class="form-control" id="dateFrom" name="dateFrom">
                    </div>
                    <div class="col-md-3">
                        <label for="dateTo" class="form-label">Đến ngày</label>
                        <input type="date" class="form-control" id="dateTo" name="dateTo">
                    </div>
                    <div class="col-md-3">
                        <label for="minAmount" class="form-label">Số tiền tối thiểu</label>
                        <input type="number" class="form-control" id="minAmount" name="minAmount" placeholder="0">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fa-solid fa-search me-1"></i>Lọc
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="fa-solid fa-times me-1"></i>Xóa bộ lọc
                        </button>
                        <div class="float-end">
                            <label for="itemsPerPage" class="form-label me-2">Hiển thị:</label>
                            <select class="form-select d-inline-block w-auto" id="itemsPerPage" name="size" onchange="changePageSize()">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="card table-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fa-solid fa-list me-2"></i>Lịch sử đơn hàng
            </h5>
            <span class="badge bg-primary" th:text="${'Tổng: ' + totalItems + ' đơn hàng'}">Tổng: 0 đơn hàng</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Mã đơn hàng</th>
                            <th>Sản phẩm</th>
                            <th>Số lượng</th>
                            <th>Giá</th>
                            <th>Trạng thái</th>
                            <th>Ngày tạo</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="order : ${orders}" th:if="${orders != null and !orders.empty}">
                            <td>
                                <span class="fw-bold text-primary" th:text="${order.id}">#12345</span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img th:src="${order.productImage}" 
                                         class="rounded me-2" 
                                         style="width: 40px; height: 40px; object-fit: cover;"
                                         alt="Product"
                                         onerror="this.src='/images/placeholder.svg'">
                                    <div>
                                        <div class="fw-semibold" th:text="${order.productName}">Tên sản phẩm</div>
                                        <small class="text-muted" th:text="${order.productType}">Loại sản phẩm</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-secondary" th:text="${order.quantity}">1</span>
                            </td>
                            <td>
                                <span class="fw-bold text-success" th:text="${#numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT')}">100,000</span> VNĐ
                            </td>
                            <td>
                                <span th:class="'order-status ' + ${order.status?.toLowerCase()}" 
                                      th:text="${order.status}">PENDING</span>
                            </td>
                            <td>
                                <span th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm')}">01/01/2025 10:30</span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" th:onclick="'viewOrderDetail(' + ${order.id} + ')'">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                        <tr th:if="${orders == null or orders.empty}">
                            <td colspan="7" class="text-center py-4">
                                <i class="fa-solid fa-inbox fa-2x text-muted mb-2"></i>
                                <p class="text-muted mb-0">Không có đơn hàng nào</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-between align-items-center mt-4">
        <div>
            <span class="text-muted">
                Hiển thị <span th:text="${currentPage * pageSize + 1}">1</span> đến 
                <span th:text="${T(java.lang.Math).min((currentPage + 1) * pageSize, totalItems)}">25</span> 
                trong tổng số <span th:text="${totalItems}">100</span> kết quả
            </span>
        </div>
        <nav aria-label="Page navigation">
            <ul class="pagination pagination-custom mb-0">
                <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                    <a class="page-link" th:href="@{/admin/users/{id}/detail(id=${user.id}, page=${currentPage - 1}, size=${pageSize})}" 
                       th:if="${currentPage > 0}">
                        <i class="fa-solid fa-chevron-left"></i>
                    </a>
                    <span class="page-link" th:if="${currentPage == 0}">
                        <i class="fa-solid fa-chevron-left"></i>
                    </span>
                </li>
                
                <li class="page-item" th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}" 
                    th:classappend="${pageNum == currentPage} ? 'active'">
                    <a class="page-link" th:href="@{/admin/users/{id}/detail(id=${user.id}, page=${pageNum}, size=${pageSize})}" 
                       th:text="${pageNum + 1}">1</a>
                </li>
                
                <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                    <a class="page-link" th:href="@{/admin/users/{id}/detail(id=${user.id}, page=${currentPage + 1}, size=${pageSize})}" 
                       th:if="${currentPage < totalPages - 1}">
                        <i class="fa-solid fa-chevron-right"></i>
                    </a>
                    <span class="page-link" th:if="${currentPage == totalPages - 1}">
                        <i class="fa-solid fa-chevron-right"></i>
                    </span>
                </li>
            </ul>
        </nav>
    </div>
</main>

<!-- Change Role Modal -->
<div class="modal fade" id="changeRoleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thay đổi vai trò người dùng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="changeRoleForm">
                    <input type="hidden" id="userId" name="userId">
                    <div class="mb-3">
                        <label for="newRole" class="form-label">Vai trò mới</label>
                        <select class="form-select" id="newRole" name="newRole" required>
                            <option value="">Chọn vai trò</option>
                            <option value="USER">Người dùng</option>
                            <option value="SELLER">Người bán</option>
                            <option value="ADMIN">Quản trị viên</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="reason" class="form-label">Lý do thay đổi</label>
                        <textarea class="form-control" id="reason" name="reason" rows="3" placeholder="Nhập lý do thay đổi vai trò..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-warning" onclick="confirmRoleChange()">Xác nhận thay đổi</button>
            </div>
        </div>
    </div>
</div>

    <div th:replace="~{fragments/admin-scripts :: admin-scripts}"></div>
    
    <script th:inline="javascript">
        // Clear filters
    function clearFilters() {
        document.getElementById('filterForm').reset();
        window.location.href = window.location.pathname;
    }
    
    // Change page size
    function changePageSize() {
        const size = document.getElementById('itemsPerPage').value;
        const url = new URL(window.location);
        url.searchParams.set('size', size);
        url.searchParams.set('page', '0'); // Reset to first page
        window.location.href = url.toString();
    }
    
    // View order detail
    function viewOrderDetail(orderId) {
        // Implement order detail modal or redirect
        alert('Xem chi tiết đơn hàng #' + orderId);
    }
    
    // Change user role
    function changeUserRole(userId) {
        document.getElementById('userId').value = userId;
        document.getElementById('newRole').value = '';
        document.getElementById('reason').value = '';
        new bootstrap.Modal(document.getElementById('changeRoleModal')).show();
    }
    
    // Confirm role change
    function confirmRoleChange() {
        const userId = document.getElementById('userId').value;
        const newRole = document.getElementById('newRole').value;
        const reason = document.getElementById('reason').value;
        
        if (!newRole) {
            alert('Vui lòng chọn vai trò mới');
            return;
        }
        
        if (!reason.trim()) {
            alert('Vui lòng nhập lý do thay đổi');
            return;
        }
        
        if (confirm(`Bạn có chắc chắn muốn thay đổi vai trò của người dùng này thành ${newRole}?`)) {
            fetch('/api/admin/users/' + userId + '/change-role', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    newRole: newRole,
                    reason: reason
                })
            })
            .then(response => {
                if (response.ok) {
                    alert('Thay đổi vai trò thành công!');
                    location.reload();
                } else {
                    response.json().then(data => {
                        alert('Lỗi: ' + (data.message || 'Có lỗi xảy ra'));
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi thay đổi vai trò');
            });
        }
    }
    
    // Initialize filters from URL params
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        
        // Set filter values from URL
        if (urlParams.get('status')) {
            document.getElementById('orderStatus').value = urlParams.get('status');
        }
        if (urlParams.get('dateFrom')) {
            document.getElementById('dateFrom').value = urlParams.get('dateFrom');
        }
        if (urlParams.get('dateTo')) {
            document.getElementById('dateTo').value = urlParams.get('dateTo');
        }
        if (urlParams.get('minAmount')) {
            document.getElementById('minAmount').value = urlParams.get('minAmount');
        }
        if (urlParams.get('size')) {
            document.getElementById('itemsPerPage').value = urlParams.get('size');
        }
    });
    </script>
</body>
</html>

